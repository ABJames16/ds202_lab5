---
title: "lab5_Adam_Banwell"
author: "Adam Banwell"
date: "10/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)



```

## R Commands

## Part one: Cleaning data
```{r}
library(dplyr)
library(ggplot2)

acc <- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/accident.csv", stringsAsFactors = FALSE)

pers<- read.csv("https://raw.githubusercontent.com/xdaiISU/ds202materials/master/hwlabs/fars2017/person.csv", stringsAsFactors = FALSE)

str(pers)
str(acc)

```

#1. Create a data frame containing the persons who are fatally hurt in the accidents (see FARS manual and look up variable INJ_SEV)
```{r}
severe = pers %>% filter(INJ_SEV %in% 4)
str(severe)
```

#2. Create a data frame containing the most dangerous vehicle make in each state. The number of persons fatally hit in the vehicle make is used to assess the (non-)safety of a make. Make sure to handle the missing values appropriately. (look up variable MAKE)
```{r}
makes = severe %>% group_by(MAKE, STATE) %>% na.omit() %>% summarise(count = sum(MAKE)) 
makesSorted = makes %>% group_by(STATE) %>% filter(count == max(count))
makesSorted = arrange(makesSorted,STATE)
           
makesSorted

```

#3. Create a map, and label each state with the most dangerous vehicle. Discuss the definition of the most dangerous vehicle, and what you find from the map. (Hint: Read the description for the STATE and COUNTY columns in the FARS manual. The state & county codes are Geographic Locator Codes (GLCs) from the General Services Administrationâ€™s (GSA) publication. Use readxl::read_xlsx to read in the GLCs.)
```{r}
makesSorted
makesfiltered = makesSorted %>% filter(STATE != 2 & STATE != 43 & STATE != 52 & STATE != 11)
#makesfiltered$sts = 1:nrow(makesfiltered)
makesfiltered
states = map_data('state') 
states
states %>% count(region)

middles = states %>%
  group_by(region) %>%
  summarise(long = mean(long), lat = mean(lat))

ggplot(states, aes(x = long, y = lat)) + geom_polygon(aes( group = group, fill = region))+
  geom_text(aes(label = makesfiltered$MAKE), data = middles,  size = 3)+
  scale_fill_viridis_d()+
  theme(legend.position = "none")
```

The definition of the most dangerous vehicle here is the amount of accidents that classify with a severe injury of 4. On the map the most common vehicle makes are 72 and 49. The evidence shows that these makes are the most dangerous vehicles in terms of severe injury across the US.

#4. Join the accident and person table (work out which variable(s) to use)
```{r}
acc
pers
joined = acc %>% left_join(pers,by="ST_CASE")
joined
```

#5. Tally the number of accidents by day of the week (DAY_WEEK), hour of the day (HOUR) and gender (SEX). Visualize the results and explain what you find.
```{r}
tallys = joined %>% group_by(DAY_WEEK, HOUR.x, SEX) %>% na.omit() %>% summarise(count = sum(ST_CASE))  %>% filter(HOUR.x<25)
tallys

ggplot(tallys, aes(x=DAY_WEEK, y=count, fill = HOUR.x))+geom_bar(stat='identity')+facet_wrap(~SEX, scales = "free")

ggplot(tallys, aes(x=HOUR.x, y=count, fill = DAY_WEEK))+geom_bar(stat='identity')+facet_wrap(~SEX, scales = "free")
```

According to the data visualizations above, accidents tend to happen later in the afternoon/evening and around the weekends. The first plots show less accidents around the middle of the week and more towards the end and beginning.

#6. Now plot a choropleth map of the number of deaths on a county level. Also explain what you find.
```{r}
counties = joined %>% group_by(COUNTY.x) %>% count(FATALS)
counties

#ggplot(states, aes(long, lat, group = group))+
  #geom_polygon(aes(fill = counties$ ), color = "white")+
  #scale_fill_viridis_c(option = "C")
```
